<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Job Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
    .rerun { background: #ffc107; border: none; padding: 4px 8px; cursor: pointer; border-radius: 4px; }
    .rerun:hover { background: #ffb300; }
  </style>
</head>
<body>
  <h1>Jobs Dashboard</h1>
  <button onclick="refresh()">ðŸ”„ Refresh</button>
  <table id="jobs">
    <thead>
      <tr><th>ID</th><th>File</th><th>Status</th><th>Created</th><th>Actions</th></tr>
    </thead>
    <tbody>
      {% for j in jobs %}
      <tr>
        <td>{{ j.id }}</td>
        <td>{{ j.original_file }}</td>
        <td>{{ j.status }}</td>
        <td>{{ j.created_at }}</td>
        <td class="api">
          <a href="/api/jobs/{{ j.id }}" target="_blank">status</a>
          {% if j.status in ['SUCCESS', 'FAILED'] %}
            â€¢ <button class="rerun" data-id="{{ j.id }}">â†» Rerun</button>
          {% endif %}
          {% if j.status == 'SUCCESS' %}
            â€¢ <a href="/api/jobs/{{ j.id }}/result" target="_blank">JSON</a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    async function refresh() {
      const res = await fetch('/api/jobs');
      const jobs = await res.json();
      const tbody = document.querySelector('#jobs tbody');
      tbody.innerHTML = jobs.map(j => `
        <tr>
          <td>${j.id}</td>
          <td>${j.original_file}</td>
          <td>${j.status}</td>
          <td>${j.created_at}</td>
          <td class="api">
            <a href="/api/jobs/${j.id}" target="_blank">status</a>
            ${(j.status==='SUCCESS' || j.status==='FAILED') ? ` â€¢ <button class="rerun" data-id="${j.id}">â†» Rerun</button>` : ''}
            ${j.status==='SUCCESS' ? ` â€¢ <a href="/api/jobs/${j.id}/result" target="_blank">JSON</a>` : ''}
          </td>
        </tr>`).join('');
    }

    async function rerunJob(id) {
      if (!confirm(`Re-run job ${id}?`)) return;
      const res = await fetch(`/api/jobs/${id}/rerun`, { method: 'POST' });
      const data = await res.json();
      if (!res.ok) alert(data.error || 'Failed to rerun');
      else {
        alert(`Rerun started! New job ID: ${data.new_job_id}`);
        refresh();
      }
    }

    document.addEventListener('click', e => {
      if (e.target.classList.contains('rerun')) {
        e.preventDefault();
        rerunJob(e.target.dataset.id);
      }
    });
  </script>
</body>
</html>